{{ define "webhook.custom.payload" -}}

{{/* Initialize arrays manually */}}
{{- $critical := list -}}
{{- $major := list -}}
{{- $minor := list -}}
{{- $resolved := list -}}

{{/* --- Loop over FIRING alerts --- */}}
{{- range .Alerts.Firing -}}
  {{- if eq .Annotations.description "Critical" -}}
    {{- $critical = append $critical . -}}
  {{- else if eq .Annotations.description "Major" -}}
    {{- $major = append $major . -}}
  {{- else if eq .Annotations.description "Minor" -}}
    {{- $minor = append $minor . -}}
  {{- end -}}
{{- end -}}

{{/* --- Loop over RESOLVED alerts --- */}}
{{- range .Alerts.Resolved -}}
  {{- $resolved = append $resolved . -}}
{{- end -}}

{{/* --- Build final JSON payload --- */}}
{
  "receiver": "{{ .Receiver }}",
  "status": "{{ .Status }}",
  "state": "{{ if eq .Status "resolved" }}ok{{ else }}alerting{{ end }}",
  "externalURL": "{{ .ExternalURL }}",
  "commonLabels": {{ toJson .CommonLabels }},
  "commonAnnotations": {{ toJson .CommonAnnotations }},
  "critical_alerts": {{ toJson $critical }},
  "major_alerts": {{ toJson $major }},
  "minor_alerts": {{ toJson $minor }},
  "resolved_alerts": {{ toJson $resolved }},
  "timestamp": "{{ now }}"
}
{{- end }}
